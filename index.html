<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MoodStock.</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f111a">
<style>
  body{background-color:#0f111a;color:#e2e8f0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;-webkit-tap-highlight-color:transparent;overscroll-behavior-y:none;margin:0}
  .scrollbar-hide::-webkit-scrollbar{display:none}
  html,body{height:100%;overflow:hidden;width:100%}
  #root{height:100%;overflow-y:auto;-webkit-overflow-scrolling:touch}
  .loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;color:#6366f1;font-weight:bold;flex-direction:column;gap:10px}
  #debug-log{display:none;padding:15px;background:rgba(50,0,0,0.9);color:#ffaaaa;font-family:monospace;position:fixed;top:0;left:0;right:0;z-index:9999;white-space:pre-wrap;font-size:11px;max-height:150px;overflow:auto;pointer-events:none;}
</style>
<!-- Libraries with crossorigin to unmask errors -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js" crossorigin="anonymous"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
<div id="debug-log"></div>
<div id="root"><div class="loading"><span>Loading App...</span></div></div>
<script>
  // Debug Logger
  function log(msg) {
    var d = document.getElementById('debug-log');
    d.style.display = 'block';
    d.innerHTML = "> " + msg + "\n" + d.innerHTML;
  }
  window.onerror = function(m, u, l) { log("Error: " + m + " (L:" + l + ")"); return false; };
</script>
<script type="text/babel">
  // Config
  const firebaseConfig = {
    apiKey: "AIzaSyDzSl1mR-AurB3dNyFLYSo3pkM4jg6sf1A",
    authDomain: "stock-stocks.firebaseapp.com",
    projectId: "stock-stocks",
    storageBucket: "stock-stocks.firebasestorage.app",
    messagingSenderId: "918894170952",
    appId: "1:918894170952:web:81e04503642e412a94197d"
  };

  // Wait for Libs
  const waitForLibs = (cb, n=0) => {
    if(window.React && window.ReactDOM && window.firebase && window.Motion) cb();
    else if(n<50) setTimeout(()=>waitForLibs(cb,n+1), 100);
    else log("Libs timeout. Reload page.");
  };

  waitForLibs(() => {
    try {
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      
      const { useState, useEffect, useMemo, useRef } = React;
      const { motion, Reorder, AnimatePresence, useDragControls } = window.Motion;

      // Icons
      const Icon=({d,className,onClick,onPointerDown})=><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick} onPointerDown={onPointerDown} style={onClick||onPointerDown?{cursor:'pointer'}:{}}><path d={d}/></svg>;
      const Ps={
        Plus:"M5 12h14M12 5v14",Shuffle:"M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5",
        Trash:"M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6",
        Link:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3",
        Grip:"M9 12h.01M15 12h.01M9 5h.01M15 5h.01M9 19h.01M15 19h.01",
        X:"M18 6 6 18M6 6l12 12",Up:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12",
        Move:"M5 9l-3 3 3 3M9 5l3-3 3 3M19 9l3 3-3 3M15 19l-3 3-3-3M2 12h20M12 2v20",
        Cloud:"M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.6-2.2-4.7-4.8-4.7-2.3 0-4.3 1.7-4.7 4H3c-1.7 0-3 1.3-3 3s1.3 3 3 3h14.5c1.4 0 2.5-1.1 2.5-2.5z",
        Ref:"M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
      };

      const fmtDt=(t)=>new Intl.DateTimeFormat('ja-JP',{month:'short',day:'numeric'}).format(new Date(t));
      
      // Robust Image Processor with Logging
      const procImg=(f)=>new Promise((res, rej)=>{
        if(!f) return rej("File empty");
        const r=new FileReader();
        r.onerror=()=>{ log("FileReader error"); rej("Read failed"); };
        r.onload=(e)=>{
          const i=new Image();
          i.onerror=()=>{ log("Image load error"); rej("Img failed"); };
          i.src=e.target.result;
          i.onload=()=>{
            try {
              // Reduced size to 600px for safety
              const c=document.createElement('canvas'),x=c.getContext('2d'),m=600;
              let w=i.width,h=i.height;
              if(w>h&&w>m){h*=m/w;w=m}else if(h>w&&h>m){w*=m/h;h=m}
              c.width=w;c.height=h;
              x.drawImage(i,0,0,w,h);
              res(c.toDataURL('image/jpeg',0.8));
            } catch(err) { log("Canvas error: "+err.message); rej(err); }
          }
        };
        r.readAsDataURL(f);
      });

      const Card=({children,onClick,className})=><div onClick={onClick} className={`backdrop-blur-xl bg-slate-800/40 border border-white/5 shadow-lg rounded-2xl ${className||''}`}>{children}</div>;
      const Badge=({cat})=>{
        const c={want:'bg-pink-500/20 text-pink-300 border-pink-500/20',inspo:'bg-cyan-500/20 text-cyan-300 border-cyan-500/20',memo:'bg-emerald-500/20 text-emerald-300 border-emerald-500/20'};
        return <span className={`px-2 py-0.5 rounded-full text-[10px] uppercase font-bold border ${c[cat]}`}>{cat}</span>;
      };

      const Modal=({isOpen,onClose,onSave,edit})=>{
        const [d,setD]=useState({title:'',url:'',cat:'want',img:'',pos:{x:50,y:50}});
        const [upl,setUpl]=useState(false);const [sav,setSav]=useState(false);const [drg,setDrg]=useState(false);
        const fR=useRef(null);const iR=useRef(null);
        useEffect(()=>{if(isOpen){if(edit)setD({title:edit.title,url:edit.url,cat:edit.category,img:edit.imageUrl,pos:edit.imagePosition||{x:50,y:50}});else setD({title:'',url:'',cat:'want',img:'',pos:{x:50,y:50}});setSav(false)}},[isOpen,edit]);
        
        const hFile=async(e)=>{
          if(e.target.files[0]){
            setUpl(true);
            try {
              const r=await procImg(e.target.files[0]);
              setD(p=>({...p,img:r,pos:{x:50,y:50}}));
            } catch(err) {
              alert("画像の読み込みに失敗しました。容量オーバーの可能性があります。");
            } finally { setUpl(false); }
          }
        };
        
        const hDrag=(e)=>{if(!iR.current)return;const r=iR.current.getBoundingClientRect(),cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY;setD(p=>({...p,pos:{x:Math.max(0,Math.min(100,((cx-r.left)/r.width)*100)),y:Math.max(0,Math.min(100,((cy-r.top)/r.height)*100))}}))};
        const sub=async()=>{if(!d.title)return;setSav(true);const i=d.img||`https://source.unsplash.com/800x800/?${encodeURIComponent(d.title)},minimal`;await onSave({...d,imageUrl:i,imagePosition:d.pos,category:d.cat},edit?.id);onClose()};
        
        return (
          <AnimatePresence>
          {isOpen&&(
            <>
              <motion.div initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}} onClick={onClose} className="fixed inset-0 bg-black/70 z-40"/>
              <motion.div initial={{y:"100%"}} animate={{y:0}} exit={{y:"100%"}} transition={{type:"spring",damping:25}} className="fixed bottom-0 left-0 right-0 z-50 flex justify-center pointer-events-none max-h-[95vh]">
                <div className="w-full max-w-md bg-slate-900 border-t border-slate-700/50 shadow-2xl pointer-events-auto rounded-t-2xl flex flex-col max-h-full p-4 md:p-6 overflow-y-auto">
                  <div className="flex justify-between mb-6"><h3 className="text-white font-medium">{edit?'Edit':'New'}</h3><button onClick={onClose} className="p-2 text-slate-400"><Icon d={Ps.X} className="w-5 h-5"/></button></div>
                  <div className="space-y-4 pb-8">
                    <div className="space-y-2">
                      <div className="flex justify-between text-xs text-slate-400 uppercase font-bold"><span>Image</span>{d.img&&<span className="text-indigo-400 flex items-center"><Icon d={Ps.Move} className="w-3 h-3 mr-1"/> Adjust</span>}</div>
                      <input type="file" ref={fR} onChange={hFile} accept="image/*" className="hidden"/>
                      <div ref={iR} onClick={()=>!d.img&&fR.current.click()} onMouseDown={()=>d.img&&setDrg(true)} onMouseUp={()=>setDrg(false)} onMouseLeave={()=>setDrg(false)} onMouseMove={(e)=>drg&&hDrag(e)} onTouchStart={()=>d.img&&setDrg(true)} onTouchEnd={()=>setDrg(false)} onTouchMove={(e)=>drg&&hDrag(e)} className={`relative w-full h-48 rounded-xl border-2 border-slate-700/50 overflow-hidden ${!d.img?'border-dashed flex items-center justify-center cursor-pointer':'cursor-move'}`}>
                        {d.img?<><img src={d.img} className="w-full h-full object-cover pointer-events-none" style={{objectPosition:`${d.pos.x}% ${d.pos.y}%`}}/><button onClick={(e)=>{e.stopPropagation();fR.current.click()}} className="absolute bottom-2 right-2 bg-black/60 text-white text-xs px-3 py-1.5 rounded-full flex items-center gap-1"><Icon d={Ps.Up} className="w-3 h-3"/> Change</button></>:upl?<div className="animate-spin w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full"/>:<div className="text-center text-slate-500"><Icon d={Ps.Up} className="w-8 h-8 mx-auto mb-2 opacity-50"/><span className="text-sm">Upload</span></div>}
                      </div>
                    </div>
                    <div><label className="text-xs text-slate-400 uppercase font-bold">Title</label><input value={d.title} onChange={e=>setD(p=>({...p,title:e.target.value}))} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white mt-1"/></div>
                    <div><label className="text-xs text-slate-400 uppercase font-bold">Category</label><div className="grid grid-cols-3 gap-2 mt-1">{['want','inspo','memo'].map(c=>(<button key={c} onClick={()=>setD(p=>({...p,cat:c}))} className={`py-2 rounded-xl text-sm font-medium border ${d.cat===c?'bg-indigo-600 border-indigo-500 text-white':'bg-slate-800 border-slate-700 text-slate-400'}`}>{c}</button>))}</div></div>
                    <div><label className="text-xs text-slate-400 uppercase font-bold">Link</label><input value={d.url} onChange={e=>setD(p=>({...p,url:e.target.value}))} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white mt-1 text-sm font-mono"/></div>
                    <button onClick={sub} disabled={!d.title||upl||sav} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 flex items-center justify-center disabled:opacity-50">{sav?<Icon d={Ps.Ref} className="w-5 h-5 animate-spin"/>:(edit?'Save':'Add')}</button>
                  </div>
                </div>
              </motion.div>
            </>
          )}
          </AnimatePresence>
        );
      };

      const Item=({i,onDel,onEdit,drag,ctl})=>{
        const C=(
          <Card onClick={onEdit} className="overflow-hidden cursor-pointer active:scale-[0.99] transition-transform">
            <div className="flex items-center p-3 gap-3">
              <div className={`text-slate-700 pl-1 py-2 pr-2 ${drag?'cursor-grab active:cursor-grabbing':'opacity-0 w-0 pr-0'}`} onPointerDown={e=>drag&&ctl.start(e)} style={{touchAction:'none'}}><Icon d={Ps.Grip} className="w-5 h-5"/></div>
              <div className="w-20 h-20 shrink-0 rounded-xl overflow-hidden bg-slate-800 relative shadow-inner border border-white/5"><img src={i.imageUrl} className="w-full h-full object-cover" style={{objectPosition:`${i.imagePosition?.x||50}% ${i.imagePosition?.y||50}%`}} onError={e=>e.target.src=`https://source.unsplash.com/400x400/?${i.category},minimal`}/></div>
              <div className="flex-1 min-w-0 flex flex-col justify-center"><h3 className="text-slate-100 font-semibold truncate pr-2">{i.title}</h3><div className="flex items-center gap-2 mt-2"><Badge cat={i.category}/><span className="text-[10px] text-slate-500 font-medium">{fmtDt(i.createdAt)}</span></div></div>
              <div className="flex items-center gap-2 pr-1">{i.url&&<a href={i.url} target="_blank" onClick={e=>e.stopPropagation()} className="p-2 text-indigo-400 bg-indigo-500/10 rounded-xl"><Icon d={Ps.Link} className="w-4 h-4"/></a>}<button onClick={e=>{e.stopPropagation();onDel(i.id)}} className="p-2 text-slate-600 hover:text-red-400 bg-slate-700/0 hover:bg-red-500/10 rounded-xl"><Icon d={Ps.Trash} className="w-4 h-4"/></button></div>
            </div>
          </Card>
        );
        if(drag) return <Reorder.Item value={i} id={i.id} dragListener={false} dragControls={ctl} className="relative mb-3 list-none">{C}</Reorder.Item>;
        return <motion.div layout className="relative mb-3">{C}</motion.div>;
      };

      const App=()=>{
        const [u,setU]=useState(null);const [lst,setLst]=useState([]);const [load,setLoad]=useState(true);const [tab,setTab]=useState('all');const [modal,setModal]=useState(false);const [edit,setEdit]=useState(null);const [st,setSt]=useState('synced');
        useEffect(()=>{
          const i=`data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="background-color:#0f111a"><rect width="512" height="512" fill="#0f111a"/><text x="50%" y="50%" dy=".35em" text-anchor="middle" font-family="sans-serif" font-weight="bold" font-size="280" fill="#6366f1">M</text></svg>')}`;
          let l=document.createElement('link');l.rel='apple-touch-icon';l.href=i;document.head.appendChild(l);
          let m=document.createElement('link');m.rel='manifest';m.href=`data:application/manifest+json;base64,${btoa(JSON.stringify({name:"MoodStock",display:"standalone",start_url:".",background_color:"#0f111a",theme_color:"#0f111a",icons:[{src:i,sizes:"512x512",type:"image/svg+xml"}]}))}`;document.head.appendChild(m);
          auth.onAuthStateChanged(usr=>{if(usr)setU(usr);else auth.signInAnonymously()});
        },[]);
        useEffect(()=>{if(!u)return;return db.collection('users').doc(u.uid).collection('items').onSnapshot(s=>{setLst(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.order??0)-(b.order??0)));setLoad(false)})},[u]);
        const hSave=async(d,id)=>{if(!u)return;setSt('saving');const r=db.collection('users').doc(u.uid).collection('items');if(id)await r.doc(id).update(d);else await r.add({...d,createdAt:Date.now(),order:lst.length});setSt('synced')};
        const hDel=async(id)=>{await db.collection('users').doc(u.uid).collection('items').doc(id).delete()};
        const hOrd=(n)=>{setLst(n);setSt('saving');if(window.t)clearTimeout(window.t);window.t=setTimeout(()=>{const b=db.batch();n.forEach((i,x)=>{b.update(db.collection('users').doc(u.uid).collection('items').doc(i.id),{order:x})});b.commit().then(()=>setSt('synced'))},1000)};
        const flt=useMemo(()=>tab==='all'?lst:lst.filter(i=>i.category===tab),[lst,tab]);

        return (
          <div className="min-h-screen bg-[#0f111a] text-slate-200 pb-36 px-4 py-6 max-w-2xl mx-auto">
            <header className="mb-6 sticky top-0 z-30 bg-[#0f111a]/80 backdrop-blur-md py-4 -mx-4 px-4 border-b border-white/5">
              <div className="flex justify-between items-center mb-4">
                <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">MoodStock.</h1>
                <div className="flex items-center gap-2"><span className="text-xs text-slate-500 border border-white/10 px-2 py-1 rounded-full flex items-center gap-1">{st==='saving'?<Icon d={Ps.Ref} className="w-3 h-3 animate-spin text-indigo-400"/>:<Icon d={Ps.Cloud} className="w-3 h-3 text-emerald-400"/>}{st==='saving'?'Saving...':'Saved'}</span></div>
              </div>
              <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">{['all','want','inspo','memo'].map(t=>(<button key={t} onClick={()=>setTab(t)} className={`px-4 py-1.5 rounded-full text-sm font-medium border ${tab===t?'bg-indigo-500/10 text-indigo-300 border-indigo-500/30':'bg-slate-800/30 text-slate-500 border-transparent'}`}>{t}</button>))}</div>
            </header>
            {load?<div className="flex justify-center py-20"><div className="animate-spin w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full"/></div>:
            <div className="space-y-3 min-h-[50vh] pb-20">
              {tab==='all'?<Reorder.Group axis="y" values={lst} onReorder={hOrd} className="space-y-3">{lst.map(i=><Item key={i.id} i={i} onDel={hDel} onEdit={()=>{setEdit(i);setModal(true)}} drag={true} ctl={useDragControls()}/>)}</Reorder.Group>:flt.map(i=><Item key={i.id} i={i} onDel={hDel} onEdit={()=>{setEdit(i);setModal(true)}} drag={false}/>)}
              {flt.length===0&&!load&&<div className="text-center py-20 text-slate-600 border-2 border-dashed border-slate-800/50 rounded-2xl">No items</div>}
            </div>}
            <button onClick={()=>{setEdit(null);setModal(true)}} className="fixed bottom-8 right-6 z-30 w-14 h-14 rounded-full bg-indigo-600 text-white shadow-lg flex items-center justify-center border border-white/20 hover:scale-105 transition-transform"><Icon d={Ps.Plus} className="w-8 h-8"/></button>
            <Modal isOpen={modal} onClose={()=>setModal(false)} onSave={hSave} edit={edit}/>
          </div>
        );
      };
      
      const root=ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App/>);
    } catch(e) { log("Init Error: " + e.message); }
  });
</script>
</body>
</html>


