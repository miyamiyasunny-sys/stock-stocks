<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MoodStock.</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f111a">

<!-- 1. デザインと機能の基盤 -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

<!-- 2. Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
    body { background-color: #0f111a; color: #f1f5f9; font-family: -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; height: 100vh; width: 100vw; }
    #root { height: 100%; overflow-y: scroll; -webkit-overflow-scrolling: touch; }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .loader { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; background: #0f111a; z-index: 9999; transition: opacity 0.5s; pointer-events: none; }
    .spinner { width: 40px; height: 40px; border: 3px solid rgba(99, 102, 241, 0.3); border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #err-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); color: #ff6b6b; padding: 20px; z-index: 10000; font-family: monospace; white-space: pre-wrap; overflow: auto; }
</style>
</head>
<body>

<div id="err-overlay"></div>
<div id="root">
    <div class="loader" id="app-loader">
        <div class="spinner"></div>
        <div style="font-weight: 600; letter-spacing: 0.05em; color: #6366f1;">MoodStock.</div>
    </div>
</div>

<script>
    window.onerror = function(msg, url, line) {
        if (msg && msg.indexOf('Script error') === -1) {
            document.getElementById('err-overlay').style.display = 'block';
            document.getElementById('err-overlay').innerText = "【Error】\n" + msg + "\nLine: " + line;
        }
        return false;
    };
</script>

<script type="text/babel">
    const firebaseConfig = {
        apiKey: "AIzaSyDzSl1mR-AurB3dNyFLYSo3pkM4jg6sf1A",
        authDomain: "stock-stocks.firebaseapp.com",
        projectId: "stock-stocks",
        storageBucket: "stock-stocks.firebasestorage.app",
        messagingSenderId: "918894170952",
        appId: "1:918894170952:web:81e04503642e412a94197d"
    };

    const startApp = () => {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, Reorder, AnimatePresence, useDragControls } = window.Motion;

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) return reject("ファイルがありません");
                if (file.size > 5 * 1024 * 1024) return reject("画像サイズが大きすぎます(5MB以下)");
                const reader = new FileReader();
                reader.onerror = () => reject("読み込みエラー");
                reader.onload = (e) => {
                    const img = new Image();
                    img.onerror = () => reject("画像データ破損");
                    img.src = e.target.result;
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const maxDim = 600; 
                            let w = img.width;
                            let h = img.height;
                            if (w > h && w > maxDim) { h *= maxDim/w; w = maxDim; }
                            else if (h > w && h > maxDim) { w *= maxDim/h; h = maxDim; }
                            canvas.width = w; canvas.height = h;
                            ctx.drawImage(img, 0, 0, w, h);
                            resolve(canvas.toDataURL('image/jpeg', 0.75));
                        } catch (err) { reject("メモリ不足エラー"); }
                    };
                };
                reader.readAsDataURL(file);
            });
        };

        const Icon = ({ p, className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={p} /></svg>
        );
        const Paths = {
            Plus: "M5 12h14M12 5v14",
            Trash: "M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6",
            Link: "M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3",
            Grip: "M9 12h.01M15 12h.01M9 5h.01M15 5h.01M9 19h.01M15 19h.01",
            X: "M18 6 6 18M6 6l12 12",
            Img: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12",
            Cloud: "M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.6-2.2-4.7-4.8-4.7-2.3 0-4.3 1.7-4.7 4H3c-1.7 0-3 1.3-3 3s1.3 3 3 3h14.5c1.4 0 2.5-1.1 2.5-2.5z",
            Ref: "M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15",
            Shuffle: "M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5"
        };

        const GlassCard = ({ children, onClick, className }) => (
            <motion.div layout onClick={onClick} whileTap={{ scale: 0.98 }} className={`backdrop-blur-xl bg-slate-800/40 border border-white/10 shadow-lg rounded-2xl overflow-hidden ${className || ''}`}>{children}</motion.div>
        );

        const StockItemCard = ({ item, onDelete, onEdit }) => {
            const controls = useDragControls();
            return (
                <Reorder.Item value={item} id={item.id} dragListener={false} dragControls={controls} className="relative list-none mb-3 touch-none">
                    <GlassCard onClick={() => onEdit(item)}>
                        <div className="flex items-center p-3 gap-3">
                            <div className="text-slate-600 px-1 py-2 cursor-grab active:cursor-grabbing touch-none" onPointerDown={(e) => controls.start(e)}><Icon p={Paths.Grip} className="w-6 h-6" /></div>
                            <div className="w-20 h-20 shrink-0 bg-slate-800 rounded-xl overflow-hidden border border-white/5 relative shadow-inner">
                                <img src={item.imageUrl} className="w-full h-full object-cover pointer-events-none" style={{objectPosition: `${item.imagePosition?.x}% ${item.imagePosition?.y}%`}} onError={(e) => e.target.style.display='none'}/>
                            </div>
                            <div className="flex-1 min-w-0 flex flex-col justify-center gap-1">
                                <h3 className="text-white font-bold text-base truncate leading-tight">{item.title}</h3>
                                <div className="flex items-center gap-2">
                                    <span className={`px-2 py-0.5 rounded-full text-[10px] uppercase font-bold border ${item.category === 'want' ? 'bg-pink-500/20 text-pink-300 border-pink-500/20' : item.category === 'inspo' ? 'bg-cyan-500/20 text-cyan-300 border-cyan-500/20' : 'bg-emerald-500/20 text-emerald-300 border-emerald-500/20'}`}>{item.category}</span>
                                </div>
                            </div>
                            <div className="flex flex-col gap-2">
                                {item.url && <a href={item.url} target="_blank" onClick={(e) => e.stopPropagation()} className="p-2 text-indigo-400 bg-white/5 rounded-xl hover:bg-indigo-500/20 transition-colors"><Icon p={Paths.Link} className="w-4 h-4" /></a>}
                                <button onClick={(e) => { e.stopPropagation(); onDelete(item.id); }} className="p-2 text-slate-500 hover:text-red-400 bg-white/5 rounded-xl hover:bg-red-500/20 transition-colors"><Icon p={Paths.Trash} className="w-4 h-4" /></button>
                            </div>
                        </div>
                    </GlassCard>
                </Reorder.Item>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [tab, setTab] = useState('all');
            const [status, setStatus] = useState('synced');
            const [modalOpen, setModalOpen] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [title, setTitle] = useState('');
            const [url, setUrl] = useState('');
            const [cat, setCat] = useState('want');
            const [img, setImg] = useState('');
            const [pos, setPos] = useState({x: 50, y: 50});
            const [isProcessing, setIsProcessing] = useState(false);
            const fileRef = useRef(null);
            const imgRef = useRef(null);

            useEffect(() => { auth.onAuthStateChanged(u => { if (u) setUser(u); else auth.signInAnonymously(); }); }, []);
            useEffect(() => {
                if (!user) return;
                const unsub = db.collection('users').doc(user.uid).collection('items').onSnapshot(snap => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    list.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
                    setItems(list);
                    const loader = document.getElementById('app-loader');
                    if(loader) loader.style.opacity = '0';
                });
                return () => unsub();
            }, [user]);

            const openModal = (item) => {
                if (item) { setEditItem(item); setTitle(item.title); setUrl(item.url); setCat(item.category); setImg(item.imageUrl); setPos(item.imagePosition || {x:50,y:50}); } 
                else { setEditItem(null); setTitle(''); setUrl(''); setCat('want'); setImg(''); setPos({x:50,y:50}); }
                setModalOpen(true);
            };

            const handleFile = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsProcessing(true);
                try { const res = await compressImage(file); setImg(res); } 
                catch (err) { alert(err); } 
                finally { setIsProcessing(false); if(fileRef.current) fileRef.current.value = ""; }
            };

            const handleDrag = (e) => {
                if(!imgRef.current) return;
                const r = imgRef.current.getBoundingClientRect();
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                const x = Math.max(0, Math.min(100, ((cx - r.left) / r.width) * 100));
                const y = Math.max(0, Math.min(100, ((cy - r.top) / r.height) * 100));
                setPos({x, y});
            };

            const handleSave = async () => {
                if(!title || !user) return;
                setStatus('saving');
                const finalImg = img || `https://source.unsplash.com/600x600/?${cat},minimal`;
                const data = { title, url, category: cat, imageUrl: finalImg, imagePosition: pos };
                const ref = db.collection('users').doc(user.uid).collection('items');
                try {
                    if (editItem) await ref.doc(editItem.id).update(data);
                    else await ref.add({ ...data, createdAt: Date.now(), order: items.length });
                    setModalOpen(false);
                } catch(e) { alert("Save Error"); }
                setStatus('synced');
            };

            const handleDelete = async (id) => {
                if(confirm("Delete this item?")) await db.collection('users').doc(user.uid).collection('items').doc(id).delete();
            };

            const handleReorder = (newOrder) => {
                setItems(newOrder);
                if(window.saveTimer) clearTimeout(window.saveTimer);
                window.saveTimer = setTimeout(async () => {
                    setStatus('saving');
                    const batch = db.batch();
                    newOrder.forEach((item, index) => {
                        const ref = db.collection('users').doc(user.uid).collection('items').doc(item.id);
                        batch.update(ref, { order: index });
                    });
                    await batch.commit();
                    setStatus('synced');
                }, 1500);
            };

            const handleShuffle = () => {
                if(window.navigator && window.navigator.vibrate) window.navigator.vibrate(50);
                const shuffled = [...items].sort(() => Math.random() - 0.5);
                handleReorder(shuffled);
            };

            const filteredItems = useMemo(() => tab === 'all' ? items : items.filter(i => i.category === tab), [items, tab]);

            return (
                <div className="pb-32 px-4 py-6 max-w-lg mx-auto min-h-screen">
                    <div className="sticky top-0 z-30 bg-[#0f111a]/80 backdrop-blur-md -mx-4 px-4 py-4 border-b border-white/5 mb-4">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">MoodStock.</h1>
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] text-slate-400 border border-white/10 px-2 py-1 rounded-full flex items-center gap-1 bg-slate-900/50">
                                    <Icon p={status==='saving' ? Paths.Ref : Paths.Cloud} className={`w-3 h-3 ${status==='saving'?'animate-spin':''}`} />{status==='saving' ? 'Saving...' : 'Cloud'}
                                </span>
                                <motion.button whileTap={{ scale: 0.9, rotate: 180 }} onClick={handleShuffle} className="p-2 rounded-full bg-slate-800 border border-slate-700 text-slate-400">
                                    <Icon p={Paths.Shuffle} className="w-4 h-4" />
                                </motion.button>
                            </div>
                        </div>
                        <div className="flex gap-2 overflow-x-auto hide-scroll pb-1">
                            {['all', 'want', 'inspo', 'memo'].map(t => (
                                <button key={t} onClick={() => setTab(t)} className={`px-4 py-2 rounded-xl text-sm font-bold border transition-all ${tab === t ? 'bg-indigo-600 border-indigo-500 text-white shadow-lg shadow-indigo-500/20' : 'bg-slate-800/50 border-transparent text-slate-400 hover:bg-slate-800'}`}>{t.toUpperCase()}</button>
                            ))}
                        </div>
                    </div>

                    <div className="min-h-[60vh]">
                        {tab === 'all' ? (
                            <Reorder.Group axis="y" values={items} onReorder={handleReorder}>
                                {items.map(item => <StockItemCard key={item.id} item={item} onDelete={handleDelete} onEdit={openModal} />)}
                            </Reorder.Group>
                        ) : (
                            filteredItems.map(item => (
                                <GlassCard key={item.id} onClick={() => openModal(item)} className="mb-3 cursor-pointer">
                                    <div className="flex items-center p-3 gap-3">
                                        <div className="w-20 h-20 shrink-0 bg-slate-800 rounded-xl overflow-hidden border border-white/5 relative"><img src={item.imageUrl} className="w-full h-full object-cover" style={{objectPosition: `${item.imagePosition?.x}% ${item.imagePosition?.y}%`}}/></div>
                                        <div className="flex-1 min-w-0"><h3 className="text-white font-bold text-base truncate">{item.title}</h3><div className="mt-1"><span className="text-xs text-slate-400 border border-slate-700 px-2 py-0.5 rounded-lg bg-slate-800">{item.category}</span></div></div>
                                    </div>
                                </GlassCard>
                            ))
                        )}
                        {filteredItems.length === 0 && <div className="text-center mt-20 text-slate-600 font-medium">No Items in {tab}</div>}
                    </div>

                    <motion.button whileTap={{ scale: 0.9 }} onClick={() => openModal(null)} className="fixed bottom-8 right-6 w-16 h-16 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-full flex items-center justify-center shadow-2xl border border-white/20 z-40 text-white"><Icon p={Paths.Plus} className="w-8 h-8" /></motion.button>

                    <AnimatePresence>
                        {modalOpen && (
                            <>
                                <motion.div initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}} onClick={()=>setModalOpen(false)} className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50" />
                                <motion.div initial={{y:"100%"}} animate={{y:0}} exit={{y:"100%"}} transition={{type:"spring", damping: 25, stiffness: 300}} className="fixed bottom-0 left-0 right-0 bg-[#151923] border-t border-slate-700 rounded-t-3xl z-[60] p-6 max-h-[95vh] overflow-y-auto">
                                    <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-white flex items-center gap-2">{editItem ? 'Edit Item' : 'New Stock'}</h2><button onClick={()=>setModalOpen(false)} className="p-2 bg-slate-800 rounded-full text-slate-400"><Icon p={Paths.X} className="w-5 h-5"/></button></div>
                                    <div className="space-y-6 pb-8">
                                        <div className="space-y-2">
                                            <div className="flex justify-between text-xs text-slate-400 font-bold tracking-wider">VISUAL {img && <span className="text-indigo-400 animate-pulse">DRAG TO ADJUST</span>}</div>
                                            <div ref={imgRef} className="relative w-full h-56 bg-slate-800 rounded-2xl overflow-hidden border-2 border-dashed border-slate-700 flex items-center justify-center cursor-pointer group" onTouchMove={img ? handleDrag : undefined} onMouseMove={img && ((e) => e.buttons===1 && handleDrag(e))} onClick={() => !img && fileRef.current.click()}>
                                                {img ? <><img src={img} className="w-full h-full object-cover pointer-events-none select-none" style={{objectPosition:`${pos.x}% ${pos.y}%`}} /><button onClick={(e)=>{e.stopPropagation();fileRef.current.click()}} className="absolute bottom-3 right-3 bg-black/70 backdrop-blur text-white text-xs font-bold px-4 py-2 rounded-full flex items-center gap-2 shadow-lg border border-white/10"><Icon p={Paths.Img} className="w-4 h-4"/> Change</button></> : <div className="text-slate-500 flex flex-col items-center gap-2 group-hover:text-indigo-400 transition-colors">{isProcessing ? <div className="spinner"></div> : <><Icon p={Paths.Img} className="w-10 h-10 opacity-50"/><span className="text-sm font-bold">Tap to Upload</span></>}</div>}
                                                <input type="file" ref={fileRef} onChange={handleFile} className="hidden" accept="image/*" />
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <div><label className="text-xs text-slate-400 font-bold block mb-2 tracking-wider">TITLE</label><input value={title} onChange={e=>setTitle(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white focus:outline-none focus:border-indigo-500 transition-colors font-medium" placeholder="What is this?" /></div>
                                            <div><label className="text-xs text-slate-400 font-bold block mb-2 tracking-wider">CATEGORY</label><div className="grid grid-cols-3 gap-3">{['want','inspo','memo'].map(c => (<button key={c} onClick={()=>setCat(c)} className={`py-3 rounded-xl text-sm font-bold border transition-all ${cat===c ? 'bg-indigo-600 border-indigo-500 text-white shadow-lg' : 'bg-slate-800 border-slate-700 text-slate-400'}`}>{c.toUpperCase()}</button>))}</div></div>
                                            <div><label className="text-xs text-slate-400 font-bold block mb-2 tracking-wider">LINK (Optional)</label><input value={url} onChange={e=>setUrl(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white font-mono text-sm focus:outline-none focus:border-indigo-500 transition-colors" placeholder="https://..." /></div>
                                        </div>
                                        <button onClick={handleSave} disabled={!title || isProcessing} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-500/25 mt-4 active:scale-[0.98] transition-all disabled:opacity-50 disabled:scale-100 flex items-center justify-center gap-2 text-lg">{editItem ? 'Update Stock' : 'Add to Collection'}</button>
                                    </div>
                                </motion.div>
                            </>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    };

    const checkLibs = (count = 0) => {
        if(window.React && window.ReactDOM && window.firebase && window.Motion) startApp();
        else if (count < 50) setTimeout(() => checkLibs(count + 1), 100);
        else alert("通信エラー: アプリの起動に失敗しました。再読み込みしてください。");
    };
    checkLibs();
</script>
</body>
</html>


