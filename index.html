<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MoodStock.</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f111a">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    
    <!-- Firebase (CDN) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #0f111a; color: #e2e8f0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        /* Prevent pull-to-refresh on mobile */
        html, body { height: 100%; overflow: hidden; position: fixed; width: 100%; }
        #root { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ★あなた専用の鍵がセットされています
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDzSl1mR-AurB3dNyFLYSo3pkM4jg6sf1A",
            authDomain: "stock-stocks.firebaseapp.com",
            projectId: "stock-stocks",
            storageBucket: "stock-stocks.firebasestorage.app",
            messagingSenderId: "918894170952",
            appId: "1:918894170952:web:81e04503642e412a94197d"
        };
        // ==========================================

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const { useState, useEffect, useMemo, useRef } = React;
        const { motion, Reorder, AnimatePresence, useDragControls } = window.Motion;

        // --- Icons ---
        const Icon = ({ path, className, onClick, style, onPointerDown }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick} style={style} onPointerDown={onPointerDown}>
                {path}
            </svg>
        );
        const Icons = {
            Plus: <path d="M5 12h14M12 5v14"/>,
            Shuffle: <path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l10.6-12.6c.8-1.1 2-1.7 3.3-1.7H22M2 6h1.4c1.3 0 2.5.6 3.3 1.7l10.6 12.6c.8 1.1 2 1.7 3.3 1.7H22"/>,
            Trash2: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"/>,
            ExternalLink: <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>,
            GripVertical: <path d="M9 12h.01M15 12h.01M9 5h.01M15 5h.01M9 19h.01M15 19h.01"/>,
            X: <path d="M18 6 6 18M6 6l12 12"/>,
            Upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>,
            Move: <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M19 9l3 3-3 3M15 19l-3 3-3-3M2 12h20M12 2v20"/>,
            Cloud: <path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.6-2.2-4.7-4.8-4.7-2.3 0-4.3 1.7-4.7 4H3c-1.7 0-3 1.3-3 3s1.3 3 3 3h14.5c1.4 0 2.5-1.1 2.5-2.5z"/>,
            Refresh: <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/>
        };

        const formatDate = (ts) => new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(new Date(ts));
        const processImageFile = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const ctx = cvs.getContext('2d');
                    const max = 800;
                    let w = img.width, h = img.height;
                    if (w > h && w > max) { h *= max/w; w = max; }
                    else if (h > w && h > max) { w *= max/h; h = max; }
                    cvs.width = w; cvs.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(cvs.toDataURL('image/jpeg', 0.8));
                };
            };
        });

        // --- Components ---
        const GlassCard = ({ children, onClick, className }) => (
            <div onClick={onClick} className={`backdrop-blur-xl bg-slate-800/40 border border-white/5 shadow-lg rounded-2xl ${className || ''}`}>
                {children}
            </div>
        );

        const CategoryBadge = ({ category }) => {
            const colors = { want: 'bg-pink-500/20 text-pink-300 border-pink-500/20', inspo: 'bg-cyan-500/20 text-cyan-300 border-cyan-500/20', memo: 'bg-emerald-500/20 text-emerald-300 border-emerald-500/20' };
            return <span className={`px-2 py-0.5 rounded-full text-[10px] uppercase font-bold border ${colors[category]}`}>{category}</span>;
        };

        const ItemModal = ({ isOpen, onClose, onSave, itemToEdit }) => {
            const [data, setData] = useState({ title: '', url: '', category: 'want', imageUrl: '', imagePos: {x:50,y:50} });
            const [isUploading, setIsUploading] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [isDragging, setIsDragging] = useState(false);
            const fileRef = useRef(null);
            const imgRef = useRef(null);

            useEffect(() => {
                if (isOpen) {
                    if (itemToEdit) setData({ ...itemToEdit, imagePos: itemToEdit.imagePosition || {x:50,y:50} });
                    else setData({ title: '', url: '', category: 'want', imageUrl: '', imagePos: {x:50,y:50} });
                    setIsSaving(false);
                }
            }, [isOpen, itemToEdit]);

            const handleFile = async (e) => {
                if(e.target.files[0]) {
                    setIsUploading(true);
                    const res = await processImageFile(e.target.files[0]);
                    setData(p => ({ ...p, imageUrl: res, imagePos: {x:50,y:50} }));
                    setIsUploading(false);
                }
            };

            const handleDrag = (e) => {
                if(!imgRef.current) return;
                const r = imgRef.current.getBoundingClientRect();
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                setData(p => ({ ...p, imagePos: { 
                    x: Math.max(0, Math.min(100, ((cx - r.left)/r.width)*100)), 
                    y: Math.max(0, Math.min(100, ((cy - r.top)/r.height)*100)) 
                }}));
            };

            const submit = async () => {
                if(!data.title) return;
                setIsSaving(true);
                const img = data.imageUrl || `https://source.unsplash.com/800x800/?${encodeURIComponent(data.title)},minimal`;
                await onSave({ ...data, imageUrl: img, imagePosition: data.imagePos }, itemToEdit?.id);
                onClose();
            };

            return (
                <AnimatePresence>
                    {isOpen && (
                        <>
                            <motion.div initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}} onClick={onClose} className="fixed inset-0 bg-black/70 backdrop-blur-sm z-40"/>
                            <motion.div initial={{y:"100%"}} animate={{y:0}} exit={{y:"100%"}} transition={{type:"spring", damping:25}} className="fixed bottom-0 left-0 right-0 z-50 flex justify-center pointer-events-none max-h-[95vh]">
                                <div className="w-full max-w-md bg-slate-900 border-t border-slate-700/50 shadow-2xl pointer-events-auto rounded-t-2xl flex flex-col max-h-full p-4 md:p-6 overflow-y-auto">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-white font-medium">{itemToEdit ? 'Edit' : 'New'}</h3>
                                        <button onClick={onClose} className="p-2 text-slate-400"><Icon path={Icons.X} className="w-5 h-5"/></button>
                                    </div>
                                    <div className="space-y-4 pb-8">
                                        <div className="space-y-2">
                                            <div className="flex justify-between text-xs text-slate-400 uppercase font-bold"><span>Image</span>{data.imageUrl && <span className="text-indigo-400 flex items-center"><Icon path={Icons.Move} className="w-3 h-3 mr-1"/> Adjust</span>}</div>
                                            <input type="file" ref={fileRef} onChange={handleFile} accept="image/*" className="hidden"/>
                                            <div ref={imgRef}
                                                onClick={() => !data.imageUrl && fileRef.current.click()}
                                                onMouseDown={() => data.imageUrl && setIsDragging(true)}
                                                onMouseUp={() => setIsDragging(false)}
                                                onMouseLeave={() => setIsDragging(false)}
                                                onMouseMove={(e) => isDragging && handleDrag(e)}
                                                onTouchStart={() => data.imageUrl && setIsDragging(true)}
                                                onTouchEnd={() => setIsDragging(false)}
                                                onTouchMove={(e) => isDragging && handleDrag(e)}
                                                className={`relative w-full h-48 rounded-xl border-2 border-slate-700/50 overflow-hidden ${!data.imageUrl ? 'border-dashed flex items-center justify-center cursor-pointer' : 'cursor-move'}`}
                                            >
                                                {data.imageUrl ? 
                                                    <><img src={data.imageUrl} className="w-full h-full object-cover pointer-events-none" style={{objectPosition:`${data.imagePos.x}% ${data.imagePos.y}%`}}/><button onClick={(e)=>{e.stopPropagation();fileRef.current.click()}} className="absolute bottom-2 right-2 bg-black/60 text-white text-xs px-3 py-1.5 rounded-full flex items-center gap-1"><Icon path={Icons.Upload} className="w-3 h-3"/> Change</button></>
                                                : isUploading ? <div className="animate-spin w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full"/> : <div className="text-center text-slate-500"><Icon path={Icons.Upload} className="w-8 h-8 mx-auto mb-2 opacity-50"/><span className="text-sm">Upload</span></div>
                                                }
                                            </div>
                                        </div>
                                        <div><label className="text-xs text-slate-400 uppercase font-bold">Title</label><input value={data.title} onChange={e=>setData(p=>({...p,title:e.target.value}))} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white mt-1"/></div>
                                        <div><label className="text-xs text-slate-400 uppercase font-bold">Category</label><div className="grid grid-cols-3 gap-2 mt-1">{['want','inspo','memo'].map(c => (<button key={c} onClick={()=>setData(p=>({...p,category:c}))} className={`py-2 rounded-xl text-sm font-medium border ${data.category===c ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400'}`}>{c}</button>))}</div></div>
                                        <div><label className="text-xs text-slate-400 uppercase font-bold">Link</label><input value={data.url} onChange={e=>setData(p=>({...p,url:e.target.value}))} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white mt-1 text-sm font-mono"/></div>
                                        <button onClick={submit} disabled={!data.title || isUploading || isSaving} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 flex items-center justify-center disabled:opacity-50">{isSaving ? <Icon path={Icons.Refresh} className="w-5 h-5 animate-spin"/> : (itemToEdit ? 'Save' : 'Add')}</button>
                                    </div>
                                </div>
                            </motion.div>
                        </>
                    )}
                </AnimatePresence>
            );
        };

        const StockCard = ({ item, onDelete, onEdit, isDraggable, controls }) => {
            const Content = (
                <GlassCard onClick={onEdit} className="overflow-hidden cursor-pointer active:scale-[0.99] transition-transform">
                    <div className="flex items-center p-3 gap-3">
                        <div className={`text-slate-700 pl-1 py-2 pr-2 ${isDraggable ? 'cursor-grab active:cursor-grabbing' : 'opacity-0 w-0 pr-0'}`} onPointerDown={e => isDraggable && controls.start(e)} style={{touchAction:'none'}}><Icon path={Icons.GripVertical} className="w-5 h-5"/></div>
                        <div className="w-20 h-20 shrink-0 rounded-xl overflow-hidden bg-slate-800 relative shadow-inner border border-white/5"><img src={item.imageUrl} className="w-full h-full object-cover" style={{objectPosition:`${item.imagePosition?.x||50}% ${item.imagePosition?.y||50}%`}} onError={e => e.target.src=`https://source.unsplash.com/400x400/?${item.category},minimal`}/></div>
                        <div className="flex-1 min-w-0 flex flex-col justify-center"><h3 className="text-slate-100 font-semibold truncate pr-2">{item.title}</h3><div className="flex items-center gap-2 mt-2"><CategoryBadge category={item.category}/><span className="text-[10px] text-slate-500 font-medium">{formatDate(item.createdAt)}</span></div></div>
                        <div className="flex items-center gap-2 pr-1">{item.url && <a href={item.url} target="_blank" onClick={e=>e.stopPropagation()} className="p-2 text-indigo-400 bg-indigo-500/10 rounded-xl"><Icon path={Icons.ExternalLink} className="w-4 h-4"/></a>}<button onClick={e=>{e.stopPropagation();onDelete(item.id)}} className="p-2 text-slate-600 hover:text-red-400 bg-slate-700/0 hover:bg-red-500/10 rounded-xl"><Icon path={Icons.Trash2} className="w-4 h-4"/></button></div>
                    </div>
                </GlassCard>
            );
            if(isDraggable) return <Reorder.Item value={item} id={item.id} dragListener={false} dragControls={controls} className="relative mb-3 list-none">{Content}</Reorder.Item>
            return <motion.div layout className="relative mb-3">{Content}</motion.div>
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [tab, setTab] = useState('all');
            const [modalOpen, setModalOpen] = useState(false);
            const [editing, setEditing] = useState(null);
            const [status, setStatus] = useState('synced');

            useEffect(() => {
                const icon = `data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="background-color:#0f111a"><rect width="512" height="512" fill="#0f111a"/><text x="50%" y="50%" dy=".35em" text-anchor="middle" font-family="sans-serif" font-weight="bold" font-size="280" fill="#6366f1">M</text></svg>')}`;
                const link = document.createElement('link'); link.rel = 'apple-touch-icon'; link.href = icon; document.head.appendChild(link);
                const manifest = { name: "MoodStock", display: "standalone", start_url: ".", background_color: "#0f111a", theme_color: "#0f111a", icons: [{ src: icon, sizes: "512x512", type: "image/svg+xml" }] };
                const mLink = document.createElement('link'); mLink.rel = 'manifest'; mLink.href = `data:application/manifest+json;base64,${btoa(JSON.stringify(manifest))}`; document.head.appendChild(mLink);
            }, []);

            useEffect(() => { auth.onAuthStateChanged(u => { if (u) setUser(u); else auth.signInAnonymously(); }); }, []);
            useEffect(() => { if(!user) return; return db.collection('users').doc(user.uid).collection('items').onSnapshot(snap => { const list = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => (a.order??0)-(b.order??0)); setItems(list); setLoading(false); }); }, [user]);

            const handleSave = async (data, id) => { if(!user) return; setStatus('saving'); const ref = db.collection('users').doc(user.uid).collection('items'); if(id) await ref.doc(id).update(data); else await ref.add({...data, createdAt: Date.now(), order: items.length}); setStatus('synced'); };
            const handleDelete = async (id) => { await db.collection('users').doc(user.uid).collection('items').doc(id).delete(); };
            const handleReorder = (newItems) => { setItems(newItems); setStatus('saving'); if(window.saveTimeout) clearTimeout(window.saveTimeout); window.saveTimeout = setTimeout(() => { const batch = db.batch(); newItems.forEach((item, idx) => { const ref = db.collection('users').doc(user.uid).collection('items').doc(item.id); batch.update(ref, {order: idx}); }); batch.commit().then(()=>setStatus('synced')); }, 1000); };
            const filtered = useMemo(() => tab==='all' ? items : items.filter(i => i.category===tab), [items, tab]);

            return (
                <div className="min-h-screen bg-[#0f111a] text-slate-200 pb-36 px-4 py-6 max-w-2xl mx-auto">
                    <header className="mb-6 sticky top-0 z-30 bg-[#0f111a]/80 backdrop-blur-md py-4 -mx-4 px-4 border-b border-white/5">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">MoodStock.</h1>
                            <div className="flex items-center gap-2"><span className="text-xs text-slate-500 border border-white/10 px-2 py-1 rounded-full flex items-center gap-1">{status==='saving' ? <Icon path={Icons.Refresh} className="w-3 h-3 animate-spin text-indigo-400"/> : <Icon path={Icons.Cloud} className="w-3 h-3 text-emerald-400"/>}{status==='saving'?'Saving...':'Saved'}</span></div>
                        </div>
                        <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">{['all','want','inspo','memo'].map(t => (<button key={t} onClick={()=>setTab(t)} className={`px-4 py-1.5 rounded-full text-sm font-medium border ${tab===t ? 'bg-indigo-500/10 text-indigo-300 border-indigo-500/30' : 'bg-slate-800/30 text-slate-500 border-transparent'}`}>{t}</button>))}</div>
                    </header>
                    {loading ? <div className="flex justify-center py-20"><div className="animate-spin w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full"/></div> :
                    <div className="space-y-3 min-h-[50vh] pb-20">
                        {tab==='all' ? <Reorder.Group axis="y" values={items} onReorder={handleReorder} className="space-y-3">{items.map(item => <StockCard key={item.id} item={item} onDelete={handleDelete} onEdit={()=>{setEditing(item);setModalOpen(true)}} isDraggable={true} controls={useDragControls()}/>)}</Reorder.Group> : filtered.map(item => <StockCard key={item.id} item={item} onDelete={handleDelete} onEdit={()=>{setEditing(item);setModalOpen(true)}} isDraggable={false}/>)}
                        {filtered.length===0 && !loading && <div className="text-center py-20 text-slate-600 border-2 border-dashed border-slate-800/50 rounded-2xl">No items</div>}
                    </div>}
                    <button onClick={()=>{setEditing(null);setModalOpen(true)}} className="fixed bottom-8 right-6 z-30 w-14 h-14 rounded-full bg-indigo-600 text-white shadow-lg flex items-center justify-center border border-white/20 hover:scale-105 transition-transform"><Icon path={Icons.Plus} className="w-8 h-8"/></button>
                    <ItemModal isOpen={modalOpen} onClose={()=>setModalOpen(false)} onSave={handleSave} itemToEdit={editing}/>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
